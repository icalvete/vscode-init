#!/bin/bash
#
# vscode-init - Inicializa proyectos con configuración para Claude Code
#
# Uso:
#   vscode-init <directorio>                    Inicializa proyecto básico
#   vscode-init <directorio> --ruby             Con convenciones Ruby
#   vscode-init <directorio> --rails            Con Ruby on Rails
#   vscode-init <directorio> --mcp-github       Con MCP de GitHub
#
# Ejemplos:
#   vscode-init ~/proyectos/mi-app
#   vscode-init ~/proyectos/mi-app --ruby
#   vscode-init ~/proyectos/mi-app --rails --mcp-github --mcp-postgres
#   vscode-init . --python

set -e

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Directorio del script (para encontrar templates)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE_DIR="$(dirname "$SCRIPT_DIR")/templates"

# Variables de flags
TARGET_DIR=""
FLAG_RUBY=false
FLAG_PYTHON=false
FLAG_JAVASCRIPT=false
FLAG_RAILS=false
FLAG_MCP_GITHUB=false
FLAG_MCP_POSTGRES=false

# Funciones de output
ok() { echo -e "${GREEN}✓${NC} $1"; }
info() { echo -e "${BLUE}→${NC} $1"; }
warn() { echo -e "${YELLOW}!${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1" >&2; exit 1; }

show_help() {
    cat << 'EOF'
vscode-init - Inicializa proyectos con configuración para Claude Code

Uso:
  vscode-init <directorio> [opciones]

Opciones:
  --ruby          Añade convenciones Ruby (YARD, rubocop)
  --python        Añade convenciones Python (PEP8, docstrings)
  --javascript    Añade convenciones JavaScript (JSDoc, ESLint)
  --rails         Añade convenciones Ruby on Rails
  --mcp-github    Configura MCP para GitHub API
  --mcp-postgres  Configura MCP para PostgreSQL
  --help, -h      Muestra esta ayuda

Ejemplos:
  vscode-init ~/proyectos/mi-app
  vscode-init ~/proyectos/mi-app --ruby
  vscode-init ~/proyectos/mi-app --rails --mcp-github
  vscode-init . --python --javascript

Estructura generada:
  mi-proyecto/
  ├── CLAUDE.md              # Contexto del proyecto
  ├── .claude/
  │   └── commands/          # Comandos personalizados
  │       ├── document.md    # /document
  │       └── review.md      # /review
  └── .vscode/
      └── settings.json      # Settings del lenguaje

Más información: https://github.com/icalvete/vscode-init
EOF
}

# Validar directorio
validate_directory() {
    local dir="$1"

    # No permitir $HOME o /
    if [[ "$dir" == "$HOME" || "$dir" == "/" ]]; then
        error "No se puede inicializar en $dir (demasiado peligroso)"
    fi

    # Advertir si ya existe CLAUDE.md
    if [[ -f "$dir/CLAUDE.md" ]]; then
        warn "Ya existe CLAUDE.md en $dir"
        read -p "¿Sobrescribir? [s/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Ss]$ ]]; then
            error "Cancelado por el usuario"
        fi
    fi
}

# Resolver ruta absoluta
resolve_path() {
    local path="$1"

    # Expandir ~
    path="${path/#\~/$HOME}"

    # Convertir a absoluta
    if [[ "$path" != /* ]]; then
        path="$(pwd)/$path"
    fi

    echo "$path"
}

# Copiar template base de CLAUDE.md
copy_base() {
    local target="$1"
    local project_name="$(basename "$target")"

    info "Creando CLAUDE.md base..."

    # Crear CLAUDE.md con el nombre del proyecto
    sed "s/{PROJECT_NAME}/$project_name/g" "$TEMPLATE_DIR/claude-md/base.md" > "$target/CLAUDE.md"

    ok "CLAUDE.md creado"
}

# Añadir sección de lenguaje al CLAUDE.md
copy_language() {
    local target="$1"
    local lang="$2"

    if [[ -f "$TEMPLATE_DIR/claude-md/$lang.md" ]]; then
        info "Añadiendo sección $lang..."
        cat "$TEMPLATE_DIR/claude-md/$lang.md" >> "$target/CLAUDE.md"
        ok "Sección $lang añadida"
    else
        warn "Template $lang.md no encontrado"
    fi
}

# Copiar settings de VS Code
copy_vscode_settings() {
    local target="$1"
    local lang="$2"

    mkdir -p "$target/.vscode"

    if [[ -f "$TEMPLATE_DIR/vscode/$lang.json" ]]; then
        if [[ -f "$target/.vscode/settings.json" ]]; then
            # Merge con jq si está disponible
            if command -v jq &> /dev/null; then
                info "Mezclando settings de $lang..."
                jq -s '.[0] * .[1]' "$target/.vscode/settings.json" "$TEMPLATE_DIR/vscode/$lang.json" > "$target/.vscode/settings.json.tmp"
                mv "$target/.vscode/settings.json.tmp" "$target/.vscode/settings.json"
            else
                warn "jq no disponible, sobrescribiendo settings"
                cp "$TEMPLATE_DIR/vscode/$lang.json" "$target/.vscode/settings.json"
            fi
        else
            cp "$TEMPLATE_DIR/vscode/$lang.json" "$target/.vscode/settings.json"
        fi
        ok "Settings de $lang configurados"
    fi
}

# Copiar comandos personalizados
copy_commands() {
    local target="$1"

    info "Copiando comandos personalizados..."

    mkdir -p "$target/.claude/commands"

    for cmd in "$TEMPLATE_DIR/commands"/*.md; do
        if [[ -f "$cmd" ]]; then
            cp "$cmd" "$target/.claude/commands/"
        fi
    done

    ok "Comandos /document y /review disponibles"
}

# Configurar MCP
setup_mcp() {
    local target="$1"
    local mcp_type="$2"

    if [[ ! -f "$TEMPLATE_DIR/mcp/$mcp_type.json" ]]; then
        warn "Template MCP $mcp_type.json no encontrado"
        return
    fi

    info "Configurando MCP $mcp_type..."

    mkdir -p "$target/.claude"

    if [[ -f "$target/.claude/mcp.json" ]]; then
        # Merge con jq si está disponible
        if command -v jq &> /dev/null; then
            jq -s '{"mcpServers": (.[0].mcpServers + .[1].mcpServers)}' \
                "$target/.claude/mcp.json" \
                "$TEMPLATE_DIR/mcp/$mcp_type.json" > "$target/.claude/mcp.json.tmp"
            mv "$target/.claude/mcp.json.tmp" "$target/.claude/mcp.json"
        else
            warn "jq no disponible, sobrescribiendo MCP config"
            cp "$TEMPLATE_DIR/mcp/$mcp_type.json" "$target/.claude/mcp.json"
        fi
    else
        cp "$TEMPLATE_DIR/mcp/$mcp_type.json" "$target/.claude/mcp.json"
    fi

    ok "MCP $mcp_type configurado"

    # Advertencia sobre tokens
    if [[ "$mcp_type" == "github" ]]; then
        warn "Recuerda editar .claude/mcp.json y añadir tu GITHUB_TOKEN"
    elif [[ "$mcp_type" == "postgres" ]]; then
        warn "Recuerda editar .claude/mcp.json y configurar POSTGRES_URL"
    fi
}

# Mostrar resumen final
show_summary() {
    local target="$1"

    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  Proyecto inicializado correctamente${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "Estructura creada:"
    echo ""

    # Mostrar árbol básico
    if [[ -f "$target/CLAUDE.md" ]]; then
        echo "  $target/"
        echo "  ├── CLAUDE.md"
    fi
    if [[ -d "$target/.claude" ]]; then
        echo "  ├── .claude/"
        if [[ -d "$target/.claude/commands" ]]; then
            echo "  │   └── commands/"
            echo "  │       ├── document.md"
            echo "  │       └── review.md"
        fi
        if [[ -f "$target/.claude/mcp.json" ]]; then
            echo "  │   └── mcp.json"
        fi
    fi
    if [[ -d "$target/.vscode" ]]; then
        echo "  └── .vscode/"
        echo "      └── settings.json"
    fi

    echo ""
    echo "Próximos pasos:"
    echo "  1. cd $target"
    echo "  2. code ."
    echo "  3. Abre Claude Code: Ctrl+Shift+P → 'Claude Code: Open'"
    echo ""
}

# Parser de argumentos
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                show_help
                exit 0
                ;;
            --ruby)
                FLAG_RUBY=true
                shift
                ;;
            --python)
                FLAG_PYTHON=true
                shift
                ;;
            --javascript|--js)
                FLAG_JAVASCRIPT=true
                shift
                ;;
            --rails)
                FLAG_RAILS=true
                FLAG_RUBY=true  # Rails implica Ruby
                shift
                ;;
            --mcp-github)
                FLAG_MCP_GITHUB=true
                shift
                ;;
            --mcp-postgres)
                FLAG_MCP_POSTGRES=true
                shift
                ;;
            -*)
                error "Opción desconocida: $1"
                ;;
            *)
                if [[ -z "$TARGET_DIR" ]]; then
                    TARGET_DIR="$1"
                else
                    error "Solo se permite un directorio"
                fi
                shift
                ;;
        esac
    done

    # Validar que se proporcionó directorio
    if [[ -z "$TARGET_DIR" ]]; then
        error "Falta directorio. Uso: vscode-init <directorio> [opciones]"
    fi
}

# Main
main() {
    parse_args "$@"

    # Resolver ruta
    TARGET_DIR="$(resolve_path "$TARGET_DIR")"

    # Validar
    validate_directory "$TARGET_DIR"

    # Crear directorio si no existe
    mkdir -p "$TARGET_DIR"

    echo ""
    info "Inicializando proyecto en: $TARGET_DIR"
    echo ""

    # Copiar base
    copy_base "$TARGET_DIR"

    # Copiar lenguajes
    if [[ "$FLAG_RUBY" == true ]]; then
        copy_language "$TARGET_DIR" "ruby"
        copy_vscode_settings "$TARGET_DIR" "ruby"
    fi

    if [[ "$FLAG_PYTHON" == true ]]; then
        copy_language "$TARGET_DIR" "python"
        copy_vscode_settings "$TARGET_DIR" "python"
    fi

    if [[ "$FLAG_JAVASCRIPT" == true ]]; then
        copy_language "$TARGET_DIR" "javascript"
        copy_vscode_settings "$TARGET_DIR" "javascript"
    fi

    # Copiar frameworks
    if [[ "$FLAG_RAILS" == true ]]; then
        copy_language "$TARGET_DIR" "rails"
    fi

    # Copiar comandos
    copy_commands "$TARGET_DIR"

    # Configurar MCP
    if [[ "$FLAG_MCP_GITHUB" == true ]]; then
        setup_mcp "$TARGET_DIR" "github"
    fi

    if [[ "$FLAG_MCP_POSTGRES" == true ]]; then
        setup_mcp "$TARGET_DIR" "postgres"
    fi

    # Resumen
    show_summary "$TARGET_DIR"
}

main "$@"
